
var uploadedFiles=[];var uploaderSettings=[];var loaded_images=[];var swfUploadObjs=[];var uploadSettingObj=[];var uploadAutosaveChecker=false;var AXUpload5=Class.create(AXUpload5,{custom:{axDeleteQueue:0,reloadFileList:function(cfg){var params={mid:current_mid,file_list_area_id:cfg.fileListAreaID,editor_sequence:cfg.editorSequence,upload_target_srl:cfg.uploadTargetSrl};if(!uploadAutosaveChecker){exec_xml('file','getFileList',params,myUpload.custom.on_complete,'error,message,files,upload_status,upload_target_srl,editor_sequence,left_size'.split(','));}},autosave:function(){if(typeof(_editorAutoSave)!='function')return;uploadAutosaveChecker=true;_editorAutoSave(true);},on_complete:function(ret,response_tags){var $list,seq,files,target_srl,up_status,remain,items,i,c,itm,file_srl,file_srls;seq=ret.editor_sequence;files=ret.files;up_status=ret.upload_status;target_srl=ret.upload_target_srl;remain=Math.floor((parseInt(ret.left_size,10)||0)/1024);if(target_srl){if(editorRelKeys[seq].primary.value!=target_srl){editorRelKeys[seq].primary.value=target_srl;myUpload.custom.autosave();}
editorRelKeys[seq].primary.value=target_srl;}
if(!uploadAutosaveChecker)myUpload.custom.autosave();},insertUploadedFile:function(editorSequence,files){var settings=uploadSettingObj[editorSequence],fileListAreaID=settings.fileListAreaID,targetFiles,targetfileID=[],uploadFile=[],text=new Array();if(editorMode[editorSequence]=='preview')return;if(files==undefined){targetFiles=myUpload.multiSelector.getSelects();if(targetFiles.length<1)return false;jQuery.each(targetFiles,function(i,file){targetfileID[file.id]=file.id;});jQuery.each(myUpload.uploadedList,function(i,file){if(!targetfileID[file.id])return true;uploadFile.push(file);});}else{uploadFile.push(files);}
editorFocus(editorSequence);jQuery.each(uploadFile,function(){if(!this.file_srl)return true;if(this.direct_download=='Y'){if(this.download_url==undefined)this.download_url=this.uploaded_filename;if(/\.(jpg|jpeg|png|gif)$/i.test(this.download_url)){if(loaded_images[this.file_srl]){var obj=loaded_images[this.file_srl];}
else{var obj=new Image();obj.src=this.download_url;}
temp_code='';temp_code+="<img src=\""+this.download_url+"\" alt=\""+this.source_filename+"\"";if(obj.complete==true){temp_code+=" width=\""+obj.width+"\" height=\""+obj.height+"\"";}
temp_code+=" />\r\n";text.push(temp_code);}else{text.push("<img src=\"common/img/blank.gif\" editor_component=\"multimedia_link\" multimedia_src=\""+this.download_url+"\" width=\"400\" height=\"320\" style=\"display:block;width:400px;height:320px;border:2px dotted #4371B9;background:url(./modules/editor/components/multimedia_link/tpl/multimedia_link_component.gif) no-repeat center;\" auto_start=\"false\" alt=\"\" />");}}else{text.push("<a href=\""+this.download_url+"\">"+this.source_filename+"</a>\n");}});if(editorMode[editorSequence]=='html'){if(text.length>0&&get_by_id('editor_textarea_'+editorSequence))
{get_by_id('editor_textarea_'+editorSequence).value+=text.join('');}}else{var iframe_obj=editorGetIFrame(editorSequence);if(!iframe_obj)return;if(text.length>0)editorReplaceHTML(iframe_obj,text.join(''));}}},uploadQueue:function(){var cfg=this.config;if(!this.queueLive)return;if(this.queue.length==0){this.uploadComplete();return;}
var uploadQueue=this.uploadQueue.bind(this);var cancelUpload=this.cancelUpload.bind(this);var uploadSuccess=this.uploadSuccess.bind(this);var onClickDeleteButton=this.onClickDeleteButton.bind(this);var onClickFileTitle=this.onClickFileTitle.bind(this);var obj=this.queue.shift();this.uploadingObj=obj;var formData=new FormData();jQuery.each(cfg.uploadPars,function(k,v){formData.append(k,v);});formData.append(cfg.uploadFileName,obj.file);var itemID=obj.id;this.xhr=new XMLHttpRequest();this.xhr.open('POST',cfg.uploadUrl,true);this.xhr.onload=function(e){var res=e.target.response;try{if(typeof res=="string")res=res.object();}catch(e){trace(e);cancelUpload();return;}
if(res.result=="err"||res.error){cfg.onError("res_error");trace(res);jQuery("#"+itemID).fadeOut("slow");cancelUpload();return;}
if(cfg.isSingleUpload){jQuery("#"+itemID+" .AXUploadBtns").show();jQuery("#"+itemID+" .AXUploadLabel").show();jQuery("#"+itemID+" .AXUploadTit").show();jQuery("#"+itemID+" .AXUploadProcess").hide();uploadSuccess(obj.file,itemID,res);jQuery("#"+itemID+" .AXUploadBtnsA").bind("click",function(){onClickDeleteButton(itemID);});if(cfg.onClickUploadedItem){jQuery("#"+itemID+" .AXUploadDownload").bind("click",function(){onClickFileTitle(itemID);});}}else{jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadLabel").show();jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadProcess").hide();if(!res[cfg.fileKeys.thumbPath])res[cfg.fileKeys.thumbPath]=res[cfg.fileKeys.uploaded_filename];if(/\.(jpg|jpeg|png|gif)$/i.test(res[cfg.fileKeys.thumbPath])){jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadIcon").css({"background-image":"url('"+(res[cfg.fileKeys.thumbPath]||"").dec()+"')"}).addClass("AXUploadPreview");}else{jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadIcon").css({"background-image":"url()"});jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadIcon").html((res[cfg.fileKeys.name].substring(res[cfg.fileKeys.name].lastIndexOf('.')+1,res[cfg.fileKeys.name].length).toLowerCase()||"none").dec().replace(".",""));}
uploadSuccess(obj.file,itemID,res);jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadBtnsA").bind("click",function(){onClickDeleteButton(itemID);});if(cfg.onClickUploadedItem){jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadDownload").bind("click",function(){onClickFileTitle(itemID);});}}
uploadQueue();};var setUploadingObj=function(){this.uploadingObj=null;};var setUploadingObjBind=setUploadingObj.bind(this);this.xhr.upload.onprogress=function(e){if(cfg.isSingleUpload){if(e.lengthComputable){jQuery("#"+itemID).find(".AXUploadProcessBar").width(((e.loaded/e.total)*100).round(2)+"%");}}else{if(e.lengthComputable){jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadProcessBar").width(((e.loaded/e.total)*100).round(2)+"%");}}
if(e.lengthComputable){if(e.loaded>e.total*0.9){setUploadingObjBind();}}};this.xhr.send(formData);},setUploadedList:function(files){var cfg=this.config;var getItemTag=this.getItemTag.bind(this);var onClickDeleteButton=this.onClickDeleteButton.bind(this);var onClickFileTitle=this.onClickFileTitle.bind(this);if(cfg.isSingleUpload){var f;if(jQuery.isArray(files)){this.uploadedList.push(files.first());f=files.first();}else{this.uploadedList.push(files);f=files;}
if(!f)return;var itemID=f.id;var uf={id:itemID,name:f[cfg.fileKeys.name],size:f[cfg.fileKeys.fileSize]};jQuery("#"+cfg.targetID+'_AX_display').empty();jQuery("#"+cfg.targetID+'_AX_display').append(this.getItemTag(itemID,uf));jQuery("#"+itemID+" .AXUploadBtns").show();jQuery("#"+itemID+" .AXUploadLabel").show();jQuery("#"+itemID+" .AXUploadTit").show();jQuery("#"+itemID+" .AXUploadProcess").hide();jQuery("#"+itemID+" .AXUploadBtnsA").bind("click",function(){onClickDeleteButton(itemID);});if(cfg.onClickUploadedItem){jQuery("#"+itemID+" .AXUploadDownload").bind("click",function(){onClickFileTitle(itemID);});}}else{this.uploadedList=files;if(cfg.queueBoxID){jQuery.each(this.uploadedList,function(fidx,f){if(f.id==undefined){trace("id key is required.");return false;}
var itemID=f.id;var uf={id:itemID,name:f[cfg.fileKeys.name],size:f[cfg.fileKeys.fileSize]};jQuery("#"+cfg.queueBoxID).prepend(getItemTag(itemID,uf));jQuery("#"+cfg.queueBoxID).find("#"+itemID).fadeIn();jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadLabel").show();jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadProcess").hide();if(!f[cfg.fileKeys.thumbPath])f[cfg.fileKeys.thumbPath]=f[cfg.fileKeys.download_url];if(/\.(jpg|jpeg|png|gif)$/i.test(f[cfg.fileKeys.thumbPath])){jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadIcon").css({"background-image":"url('"+(f[cfg.fileKeys.thumbPath]||"").dec()+"')"}).addClass("AXUploadPreview");}else{jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadIcon").css({"background-image":"url()"});jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadIcon").html((f[cfg.fileKeys.name].substring(f[cfg.fileKeys.name].lastIndexOf('.')+1,f[cfg.fileKeys.name].length).toLowerCase()||"none").dec().replace(".",""));}
jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadBtnsA").bind("click",function(){onClickDeleteButton(itemID);});if(cfg.onClickUploadedItem){jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadDownload").attr("title",uploadSettingObj[editorSequence].lang.uploadButtonEditor);jQuery("#"+cfg.queueBoxID).find("#"+itemID+" .AXUploadDownload").bind("click",function(){onClickFileTitle(itemID);});}
jQuery("#"+itemID).addClass("readyselect");});this.multiSelector.collect();}}},onFileDragOver:function(evt){var cfg=this.config;jQuery("#"+cfg.dropBoxID).addClass("onDrop");jQuery("#"+cfg.dropBoxID+"_dropZoneBox").show();jQuery("#"+cfg.dropBoxID+"_dropZoneBox").css({height:jQuery("#"+cfg.dropBoxID).prop("scrollHeight")-6,width:jQuery("#"+cfg.dropBoxID).innerWidth()-6});var dropZone=document.getElementById(cfg.dropBoxID+"_dropZoneBox");dropZone.addEventListener('dragleave',function(evt){jQuery("#"+cfg.dropBoxID).removeClass("onDrop");jQuery("#"+cfg.dropBoxID+"_dropZoneBox").hide();},false);evt.stopPropagation();evt.preventDefault();evt.dataTransfer.dropEffect='copy';},deleteFile:function(file,onEnd){var cfg=this.config;if(!onEnd)if(!confirm(AXConfig.AXUpload5.deleteConfirm))return;var removeUploadedList=this.removeUploadedList.bind(this);if(file!=undefined){var pars=[];var sendPars="";jQuery.each(file,function(k,v){pars.push(k+'='+v);});if(typeof(cfg.deletePars)==="object"){jQuery.each(cfg.deletePars,function(k,v){pars.push(k+'='+v);});sendPars=pars.join("&");}else{sendPars=pars.join("&")+"&"+cfg.deletePars;}
if(cfg.isSingleUpload){jQuery("#"+file.id+" .AXUploadBtns").hide();}else{jQuery("#"+cfg.queueBoxID).find("#"+file.id+" .AXUploadBtns").hide();}
new AXReq(cfg.deleteUrl,{debug:false,pars:sendPars,contentType:"application/json",onsucc:function(res){if(res.message==AXConfig.AXReq.okCode){if(cfg.isSingleUpload){jQuery('#'+cfg.targetID+'_AX_display').html(AXConfig.AXUpload5.uploadSelectTxt);}else{jQuery("#"+file.id).hide(function(){jQuery(this).remove();});}
removeUploadedList(file.id);var response_tags={res:res,file:file};if(cfg.onDelete)cfg.onDelete.call(response_tags,response_tags);if(onEnd)onEnd();myUpload.custom.axDeleteQueue-=1;if(myUpload.custom.axDeleteQueue<1){if(cfg.onComplete)cfg.onComplete.call(response_tags,response_tags);}}else{jQuery("#"+cfg.queueBoxID).find("#"+file.id+" .AXUploadBtns").show();}}});}else{trace("file undefined");}},deleteSelect:function(arg){if(arg=="all"){if(!confirm(AXConfig.AXUpload5.deleteConfirm)){return false;}
var deleteQueue=[];if(this.uploadedList.length==0){toast.push({body:uploadSettingObj[editorSequence].lang.error_deleteQueue,type:'Warning'});}
jQuery.each(this.uploadedList,function(){deleteQueue.push(this.id);});this.ccDelete(deleteQueue,0);myUpload.custom.axDeleteQueue=deleteQueue.length;deleteQueue=null;}else{if(!this.multiSelector)toast.push({body:uploadSettingObj[editorSequence].lang.msg_file_cart_is_null,type:'Warning'});var selectObj=this.multiSelector.getSelects();if(selectObj.length>0){if(!confirm(AXConfig.AXUpload5.deleteConfirm)){return false;}
var deleteQueue=[];jQuery.each(selectObj,function(){deleteQueue.push(this.id);});this.ccDelete(deleteQueue,0);myUpload.custom.axDeleteQueue=deleteQueue.length;deleteQueue=null;}else{toast.push({body:uploadSettingObj[editorSequence].lang.msg_file_cart_is_null,type:'Warning'});}}}});var myUpload=new AXUpload5();var fnObj={pageStart:function(cfg){fnObj.upload.init(cfg);},upload:{init:function(cfg){var seq=cfg.editorSequence;if(!is_def(seq))return;cfg=jQuery.extend({url:request_uri+'index.php',sessionName:"PHPSESSID"},cfg);uploadSettingObj[seq]=cfg;jQuery("#uploadQueueBox").bind("contextmenu",function(event){event.preventDefault();});jQuery("#uploadQueueBox").bind("selectstart",function(event){event.preventDefault();});jQuery("#uploadQueueBox").bind("dragstart",function(event){event.preventDefault();});jQuery("#uploadQueueBox").css('MozUserSelect','none');jQuery("#uploadQueueBox").mousedown(function(){return false;});AXConfig.AXReq.okCode="success";AXConfig.AXUpload5={buttonTxt:cfg.lang.uploadButtonTitle,deleteConfirm:cfg.lang.confirm_delete,uploadSelectTxt:cfg.uploadSelectTxt,dropZoneTxt:cfg.dropZoneTxt}
AXConfig.AXProgress.cancelMsg=cfg.cancelMsg;myUpload.setConfig({targetID:"AXUpload5",targetButtonClass:"Blue",uploadFileName:"Filedata",file_types:"*.*",dropBoxID:"uploadQueueBox",queueBoxID:"uploadQueueBox",flash_url:request_uri+"modules/editor/skins/xpresseditor_axisj/_AXJ/lib/swfupload.swf",flash9_url:request_uri+"modules/editor/skins/xpresseditor_axisj/_AXJ/lib/swfupload_fp9.swf",onClickUploadedItem:function(){myUpload.custom.insertUploadedFile(cfg.editorSequence,this);},uploadMaxFileSize:cfg.uploadMaxFileSize,uploadMaxFileCount:0,uploadUrl:cfg.url,uploadPars:{PHPSESSID:getCookie(cfg.sessionName),editor_sequence:cfg.editorSequence,mid:current_mid,act:"procFileUpload",upload_target_srl:editorRelKeys[cfg.editorSequence].primary.value,xe_json_callback:"xe_json_callback",uploaded_count:true,width:70,},deleteUrl:cfg.url,deletePars:{editor_sequence:cfg.editorSequence,module:"file",act:"procFileDelete",upload_target_srl:editorRelKeys[cfg.editorSequence].primary.value,xe_json_callback:"xe_json_callback",uploaded_count:true,},fileKeys:{name:"source_filename",fileSize:"file_size",download_url:"download_url",uploaded_filename:"uploaded_filename",file_srl:"file_srl",thumbPath:"thumbnail_src",uploaded_count:"uploaded_count",editor_sequence:"editor_sequence",upload_status:"upload_status",left_size:"left_size",},onUpload:function(uploadedItem){cfg.insertedFiles=uploadedItem.uploaded_count;jQuery('#'+cfg.uploaderStatusID+' .attach_size').html(filesize(cfg.uploadMaxFileSize-cfg.uploadLeftFileSize));},onComplete:function(data,ee){jQuery("#uploadCancelBtn").get(0).disabled=true;if(cfg.insertedFiles!=myUpload.uploadedList.length){fnObj.upload.getFileList(cfg,true);}
myUpload.custom.reloadFileList(uploadSettingObj[cfg.editorSequence]);},onStart:function(){jQuery.each(myUpload.queue,function(i,obj){if(cfg.allowed_filetypes!="*.*"&&cfg.allowed_filetypes.indexOf(obj.file.name.substring(obj.file.name.lastIndexOf('.')+1,obj.file.name.length).toLowerCase())<0){myUpload.config.onError(cfg.lang.allowed_filetypes);myUpload.cancelUpload();return false;}
cfg.uploadLeftFileSize-=obj.file.size;if(cfg.uploadLeftFileSize<0){myUpload.config.onError(cfg.lang.uploadFileSize);myUpload.cancelUpload();return false;}});jQuery("#uploadCancelBtn").get(0).disabled=false;},onDelete:function(deletedItem){cfg.uploadLeftFileSize=Number(cfg.uploadLeftFileSize)+Number(deletedItem.file.file_size);cfg.insertedFiles=deletedItem.res.uploaded_count;jQuery('#'+cfg.uploaderStatusID+' .attach_size').html(filesize(cfg.uploadMaxFileSize-cfg.uploadLeftFileSize));},onError:function(errorType,extData){if(errorType=="html5Support"){if(AXUtil.getCookie('AXUpload5mode'))return false;AXUtil.setCookie('AXUpload5mode','SWFUpload');toast.push({body:cfg.lang.error_html5Support,type:'Caution'});}else if(errorType=="res_error"){toast.push({body:cfg.lang.res_error,type:'Caution'});}else if(errorType=="fileSize"){toast.push({body:sprintf(cfg.lang.error_fileSize,extData.name,extData.size.byte()),type:'Warning'});}else if(errorType=="fileCount"){toast.push({body:cfg.lang.error_fileCount,type:'Warning'});}else{toast.push({body:errorType,type:'Warning'});}}});myUpload.multiSelector.config.moveSens=2;fnObj.upload.getFileList(cfg);},getFileList:function(cfg,upload_status){function setUploadedList(response_tags){if(upload_status==true){cfg.uploadLeftFileSize=response_tags.left_size;jQuery('#'+cfg.uploaderStatusID+' .attach_size').html(filesize(cfg.uploadMaxFileSize-cfg.uploadLeftFileSize));}
myUpload.uploadedList=[];jQuery('#'+myUpload.config.queueBoxID).find('.AXUploadItem').remove();if(response_tags.files==undefined){return false;}else if(!response_tags.files.item.length){response_tags.files.item[0]=response_tags.files.item;}
var res=[];jQuery.each(response_tags.files.item,function(i,file){if(file==null)return true;file.id='AX'+AXUtil.timekey()+'_AX_'+(response_tags.files.item.length-i-1);res[i]=file;});myUpload.setUploadedList(res);}
var params={mid:current_mid,module:'file',act:'getFileList',editor_sequence:cfg.editorSequence,width:70};exec_xml('file','getFileList',params,setUploadedList,'error,message,files,upload_status,upload_target_srl,editor_sequence,left_size'.split(','));},changeOption:function(thumbvar){myUpload.changeConfig({fileKeys:{name:"source_filename",fileSize:"file_size",download_url:"download_url",uploaded_filename:"uploaded_filename",thumbPath:"thumbnail_src",uploaded_count:"uploaded_count",editor_sequence:"editor_sequence",upload_status:"upload_status",left_size:"left_size"}});}}};window.editorUploadInit=fnObj.pageStart;jQuery(function(){try{document.execCommand('BackgroundImageCache',false,true);}catch(e){}});window.sprintf||(function(){var _BITS={i:0x8011,d:0x8011,u:0x8021,o:0x8161,x:0x8261,X:0x9261,f:0x92,c:0x2800,s:0x84},_PARSE=/%(?:(\d+)\$)?(#|0)?(\d+)?(?:\.(\d+))?(l)?([%iduoxXfcs])/g;window.sprintf=_sprintf;function _sprintf(format){function _fmt(m,argidx,flag,width,prec,size,types){if(types==="%"){return"%";}
var v="",w=_BITS[types],overflow,pad;idx=argidx?parseInt(argidx):next++;w&0x400||(v=(av[idx]===void 0)?"":av[idx]);w&3&&(v=(w&1)?parseInt(v):parseFloat(v),v=isNaN(v)?"":v);w&4&&(v=((types==="s"?v:types)||"").toString());w&0x20&&(v=(v>=0)?v:v%0x100000000+0x100000000);w&0x300&&(v=v.toString(w&0x100?8:16));w&0x40&&(flag==="#")&&(v=((w&0x100)?"0":"0x")+v);w&0x80&&prec&&(v=(w&2)?v.toFixed(prec):v.slice(0,prec));w&0x6000&&(overflow=(typeof v!=="number"||v<0));w&0x2000&&(v=overflow?"":String.fromCharCode(v));w&0x8000&&(flag=(flag==="0")?"":flag);v=w&0x1000?v.toString().toUpperCase():v.toString();if(!(w&0x800||width===void 0||v.length>=width)){pad=Array(width-v.length+1).join(!flag?" ":flag==="#"?" ":flag);v=((w&0x10&&flag==="0")&&!v.indexOf("-"))?("-"+pad+v.slice(1)):(pad+v);}
return v;}
var next=1,idx=0,av=arguments;return format.replace(_PARSE,_fmt);}
window.filesize=_filesize;function _filesize(size)
{if(!size)
{return'0Byte';}
if(size===1)
{return'1Byte';}
if(size<1024)
{return size+'Bytes';}
if(size>=1024&&size<1024*1024)
{return sprintf("%0.1fKB",size/1024);}
return sprintf("%0.2fMB",size/(1024*1024));}})();
